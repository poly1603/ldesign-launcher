# Vite Launcher - 架构设计

## 整体架构

### 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    用户接口层 (API Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  ViteLauncher  │  便捷函数  │  类型定义  │  错误处理        │
├─────────────────────────────────────────────────────────────┤
│                    核心业务层 (Core Layer)                   │
├─────────────────────────────────────────────────────────────┤
│  项目管理  │  开发服务器  │  构建系统  │  预览服务器        │
├─────────────────────────────────────────────────────────────┤
│                    服务层 (Service Layer)                    │
├─────────────────────────────────────────────────────────────┤
│ ProjectDetector │ ConfigManager │ PluginManager │ ErrorHandler │
├─────────────────────────────────────────────────────────────┤
│                    工具层 (Utility Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  文件操作  │  模板引擎  │  日志系统  │  工具函数          │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件设计

### 1. ViteLauncher (核心控制器)

**职责**：
- 统一的入口点和 API 接口
- 协调各个服务组件
- 管理实例生命周期
- 提供配置管理

**设计模式**：
- 外观模式 (Facade Pattern)
- 单例模式 (Singleton Pattern)
- 依赖注入 (Dependency Injection)

**核心方法**：
```typescript
class ViteLauncher {
  // 项目管理
  async create(path: string, type: ProjectType, options?: CreateOptions): Promise<void>
  
  // 开发服务器
  async dev(path?: string, options?: DevOptions): Promise<ViteDevServer>
  
  // 构建系统
  async build(path?: string, options?: BuildOptions): Promise<BuildResult>
  
  // 预览服务器
  async preview(path?: string, options?: PreviewOptions): Promise<ViteDevServer>
  
  // 工具方法
  async getProjectInfo(path?: string): Promise<ProjectInfo>
  async getProjectType(path?: string): Promise<ProjectType>
}
```

### 2. ProjectDetector (项目检测器)

**职责**：
- 检测项目类型和框架
- 分析项目依赖和配置
- 生成项目信息报告

**检测策略**：
```typescript
interface DetectionStrategy {
  // 文件系统检测
  detectByFiles(projectPath: string): Promise<ProjectType>
  
  // 依赖包检测
  detectByDependencies(dependencies: Record<string, string>): ProjectType
  
  // 配置文件检测
  detectByConfig(projectPath: string): Promise<ProjectType>
  
  // 综合评分
  calculateConfidence(signals: DetectionSignal[]): number
}
```

### 3. ConfigManager (配置管理器)

**职责**：
- 管理 Vite 配置生成
- 处理配置合并和覆盖
- 提供配置预设

**配置层次**：
```
用户配置 (最高优先级)
    ↓
项目配置
    ↓
框架预设
    ↓
默认配置 (最低优先级)
```

### 4. PluginManager (插件管理器)

**职责**：
- 管理 Vite 插件生命周期
- 根据项目类型选择插件
- 处理插件配置和依赖

**插件分类**：
- **框架插件**：Vue、React、Svelte 等
- **功能插件**：TypeScript、CSS 预处理器等
- **优化插件**：代码分割、压缩等
- **开发插件**：热更新、调试工具等

### 5. ErrorHandler (错误处理器)

**职责**：
- 统一错误处理和格式化
- 提供用户友好的错误信息
- 错误恢复和建议

**错误分类**：
```typescript
enum ErrorCode {
  // 文件系统错误
  FILE_NOT_FOUND = 'E001',
  PERMISSION_DENIED = 'E002',
  
  // 配置错误
  INVALID_CONFIG = 'E003',
  MISSING_DEPENDENCY = 'E004',
  
  // 运行时错误
  SERVER_START_FAILED = 'E005',
  BUILD_FAILED = 'E006',
}
```

## 数据流设计

### 项目创建流程
```
用户输入 → 参数验证 → 目录检查 → 模板选择 → 文件生成 → 依赖安装 → 配置生成
```

### 开发服务器启动流程
```
项目检测 → 配置生成 → 插件加载 → 服务器创建 → 端口监听 → 浏览器打开
```

### 构建流程
```
项目分析 → 配置合并 → 插件应用 → 代码构建 → 资源优化 → 输出分析
```

## 模块化设计

### 目录结构
```
src/
├── core/                 # 核心业务逻辑
│   ├── ViteLauncher.ts   # 主控制器
│   └── index.ts          # 核心模块导出
├── services/             # 服务层
│   ├── ProjectDetector.ts
│   ├── ConfigManager.ts
│   ├── PluginManager.ts
│   └── ErrorHandler.ts
├── utils/                # 工具函数
│   ├── file.ts           # 文件操作
│   ├── template.ts       # 模板处理
│   └── logger.ts         # 日志系统
├── types/                # 类型定义
│   └── index.ts
├── templates/            # 项目模板
│   ├── vue3/
│   ├── react/
│   └── vanilla/
└── index.ts              # 主入口
```

### 模块依赖关系
```
ViteLauncher
    ├── ProjectDetector
    ├── ConfigManager
    │   └── PluginManager
    ├── ErrorHandler
    └── Utils
```

## 扩展性设计

### 插件系统
```typescript
interface Plugin {
  name: string
  version: string
  apply(launcher: ViteLauncher): void
  hooks?: {
    beforeCreate?: (options: CreateOptions) => void
    afterCreate?: (result: CreateResult) => void
    beforeBuild?: (config: ViteConfig) => void
    afterBuild?: (result: BuildResult) => void
  }
}
```

### 配置扩展
```typescript
interface ConfigExtension {
  name: string
  condition: (projectInfo: ProjectInfo) => boolean
  config: (baseConfig: ViteConfig) => ViteConfig
}
```

### 模板系统
```typescript
interface Template {
  name: string
  framework: ProjectType
  files: TemplateFile[]
  dependencies: Record<string, string>
  devDependencies: Record<string, string>
  scripts: Record<string, string>
}
```

## 性能优化设计

### 缓存策略
- **配置缓存**：缓存生成的 Vite 配置
- **检测缓存**：缓存项目类型检测结果
- **模板缓存**：缓存模板文件内容
- **依赖缓存**：缓存依赖解析结果

### 懒加载
- 按需加载框架特定的插件
- 延迟初始化非关键服务
- 动态导入大型依赖包

### 并行处理
- 并行进行文件操作
- 并行安装依赖包
- 并行执行构建任务

## 安全性设计

### 输入验证
- 路径安全检查
- 参数类型验证
- 配置项合法性检查

### 文件系统安全
- 防止路径遍历攻击
- 限制文件操作范围
- 安全的临时文件处理

### 依赖安全
- 依赖包版本锁定
- 安全漏洞检查
- 最小权限原则

## 测试架构

### 测试分层
```
E2E 测试 (端到端测试)
    ↓
集成测试 (组件集成)
    ↓
单元测试 (函数级别)
```

### 测试策略
- **单元测试**：每个函数和类的独立测试
- **集成测试**：组件间交互测试
- **E2E 测试**：完整工作流程测试
- **性能测试**：关键路径性能验证
