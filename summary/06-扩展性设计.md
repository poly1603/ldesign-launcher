# Vite Launcher - 扩展性设计

## 扩展性架构

### 核心扩展点

Vite Launcher 提供了多个扩展点，允许开发者根据需要定制和扩展功能：

1. **插件系统** - 扩展构建和开发功能
2. **模板系统** - 自定义项目模板
3. **配置系统** - 自定义配置预设
4. **钩子系统** - 生命周期扩展
5. **检测器扩展** - 自定义项目类型检测

### 扩展架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      用户扩展层                              │
├─────────────────────────────────────────────────────────────┤
│  自定义插件  │  自定义模板  │  自定义配置  │  自定义钩子    │
├─────────────────────────────────────────────────────────────┤
│                      扩展接口层                              │
├─────────────────────────────────────────────────────────────┤
│  Plugin API  │  Template API │  Config API  │  Hook API     │
├─────────────────────────────────────────────────────────────┤
│                      核心系统层                              │
├─────────────────────────────────────────────────────────────┤
│  ViteLauncher │  PluginManager │ ConfigManager │ HookManager │
└─────────────────────────────────────────────────────────────┘
```

## 插件系统

### 插件接口定义

```typescript
interface LauncherPlugin {
  name: string
  version?: string
  description?: string
  
  // 插件应用函数
  apply(launcher: ViteLauncher, options?: any): void
  
  // 插件配置
  config?: PluginConfig
  
  // 依赖声明
  dependencies?: string[]
  
  // 兼容性检查
  compatibility?: {
    launcher?: string    // 启动器版本要求
    node?: string       // Node.js 版本要求
    frameworks?: string[] // 支持的框架
  }
}
```

### 插件开发示例

```typescript
// 自定义插件示例
export const myCustomPlugin: LauncherPlugin = {
  name: 'my-custom-plugin',
  version: '1.0.0',
  description: '自定义功能插件',
  
  apply(launcher: ViteLauncher, options = {}) {
    // 1. 注册钩子
    launcher.hooks.beforeCreate.tap('my-plugin', async (createOptions) => {
      console.log('准备创建项目:', createOptions)
      
      // 自定义逻辑
      if (createOptions.type === 'vue3') {
        createOptions.features = [...(createOptions.features || []), 'my-feature']
      }
    })
    
    // 2. 扩展配置
    launcher.hooks.configResolved.tap('my-plugin', (config) => {
      if (options.enableCustomFeature) {
        config.plugins.push(myVitePlugin())
      }
    })
    
    // 3. 添加命令
    launcher.addCommand('my-command', async (args) => {
      console.log('执行自定义命令:', args)
    })
  },
  
  config: {
    enableCustomFeature: true,
    customOption: 'default-value'
  }
}

// 使用插件
const launcher = new ViteLauncher()
launcher.use(myCustomPlugin, {
  enableCustomFeature: true
})
```

### 内置插件扩展点

```typescript
// 框架插件接口
interface FrameworkPlugin extends LauncherPlugin {
  framework: ProjectType
  detectProject(projectPath: string): Promise<boolean>
  generateTemplate(templateData: TemplateData): Promise<TemplateFile[]>
  getViteConfig(mode: BuildMode): ViteConfig
}

// CSS 预处理器插件
interface CSSPlugin extends LauncherPlugin {
  preprocessor: 'sass' | 'less' | 'stylus'
  getVitePlugin(): VitePlugin
  getDefaultConfig(): any
}
```

## 模板系统

### 模板结构定义

```typescript
interface ProjectTemplate {
  name: string
  framework: ProjectType
  description: string
  
  // 模板文件
  files: TemplateFile[]
  
  // 依赖配置
  dependencies: Record<string, string>
  devDependencies: Record<string, string>
  
  // 脚本配置
  scripts: Record<string, string>
  
  // 模板变量
  variables: TemplateVariable[]
  
  // 条件渲染
  conditions?: TemplateCondition[]
}

interface TemplateFile {
  path: string
  content: string
  encoding?: 'utf-8' | 'binary'
  executable?: boolean
}
```

### 自定义模板开发

```typescript
// 创建自定义模板
export const myVue3Template: ProjectTemplate = {
  name: 'my-vue3-template',
  framework: 'vue3',
  description: '我的 Vue 3 项目模板',
  
  files: [
    {
      path: 'src/main.ts',
      content: `
import { createApp } from 'vue'
import App from './App.vue'
{{#if router}}
import router from './router'
{{/if}}
{{#if pinia}}
import { createPinia } from 'pinia'
{{/if}}

const app = createApp(App)

{{#if router}}
app.use(router)
{{/if}}
{{#if pinia}}
app.use(createPinia())
{{/if}}

app.mount('#app')
      `
    },
    {
      path: 'src/App.vue',
      content: `
<template>
  <div id="app">
    <h1>{{ projectName }}</h1>
    {{#if router}}
    <router-view />
    {{else}}
    <HelloWorld />
    {{/if}}
  </div>
</template>

<script setup lang="ts">
{{#unless router}}
import HelloWorld from './components/HelloWorld.vue'
{{/unless}}
</script>
      `
    }
  ],
  
  dependencies: {
    'vue': '^3.3.0'
  },
  
  devDependencies: {
    '@vitejs/plugin-vue': '^4.0.0',
    'typescript': '^5.0.0',
    'vue-tsc': '^1.0.0'
  },
  
  scripts: {
    'dev': 'vite',
    'build': 'vue-tsc && vite build',
    'preview': 'vite preview'
  },
  
  variables: [
    {
      name: 'projectName',
      type: 'string',
      default: 'My Vue App',
      prompt: '请输入项目名称:'
    },
    {
      name: 'router',
      type: 'boolean',
      default: false,
      prompt: '是否使用 Vue Router?'
    },
    {
      name: 'pinia',
      type: 'boolean',
      default: false,
      prompt: '是否使用 Pinia 状态管理?'
    }
  ]
}

// 注册模板
launcher.registerTemplate(myVue3Template)
```

### 模板引擎扩展

```typescript
// 自定义模板处理器
interface TemplateProcessor {
  name: string
  process(content: string, data: any): Promise<string>
}

const myTemplateProcessor: TemplateProcessor = {
  name: 'my-processor',
  async process(content: string, data: any): Promise<string> {
    // 自定义模板处理逻辑
    return content
      .replace(/\{\{(\w+)\}\}/g, (match, key) => data[key] || '')
      .replace(/\{\{#if (\w+)\}\}([\s\S]*?)\{\{\/if\}\}/g, (match, condition, block) => {
        return data[condition] ? block : ''
      })
  }
}

launcher.registerTemplateProcessor(myTemplateProcessor)
```

## 配置系统扩展

### 配置预设定义

```typescript
interface ConfigPreset {
  name: string
  description: string
  framework?: ProjectType
  mode?: BuildMode
  
  // Vite 配置
  viteConfig: ViteConfig | ((context: ConfigContext) => ViteConfig)
  
  // 依赖配置
  dependencies?: Record<string, string>
  devDependencies?: Record<string, string>
  
  // 条件应用
  condition?: (context: ConfigContext) => boolean
}

// 自定义配置预设
export const myConfigPreset: ConfigPreset = {
  name: 'my-preset',
  description: '我的自定义配置预设',
  framework: 'vue3',
  
  viteConfig: (context) => ({
    plugins: [
      vue(),
      // 自定义插件
      myCustomVitePlugin(context.options)
    ],
    
    resolve: {
      alias: {
        '@': path.resolve(context.projectPath, 'src'),
        '@components': path.resolve(context.projectPath, 'src/components')
      }
    },
    
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: '@import "@/styles/variables.scss";'
        }
      }
    },
    
    build: {
      rollupOptions: {
        output: {
          manualChunks: {
            vendor: ['vue', 'vue-router'],
            utils: ['lodash', 'axios']
          }
        }
      }
    }
  }),
  
  dependencies: {
    'vue-router': '^4.0.0',
    'pinia': '^2.0.0'
  },
  
  devDependencies: {
    'sass': '^1.60.0'
  },
  
  condition: (context) => {
    return context.features.includes('advanced-setup')
  }
}

// 注册配置预设
launcher.registerConfigPreset(myConfigPreset)
```

## 钩子系统

### 生命周期钩子

```typescript
interface LauncherHooks {
  // 项目创建钩子
  beforeCreate: AsyncSeriesHook<[CreateOptions]>
  afterCreate: AsyncSeriesHook<[CreateResult]>
  
  // 开发服务器钩子
  beforeDev: AsyncSeriesHook<[DevOptions]>
  afterDev: AsyncSeriesHook<[ViteDevServer]>
  
  // 构建钩子
  beforeBuild: AsyncSeriesHook<[BuildOptions]>
  afterBuild: AsyncSeriesHook<[BuildResult]>
  
  // 配置钩子
  configResolved: SyncHook<[ViteConfig]>
  configModified: SyncHook<[ViteConfig, ConfigContext]>
  
  // 项目检测钩子
  projectDetected: AsyncSeriesHook<[ProjectInfo]>
  
  // 错误处理钩子
  error: AsyncSeriesHook<[Error, string]>
}
```

### 钩子使用示例

```typescript
// 注册钩子监听器
launcher.hooks.beforeCreate.tapAsync('my-plugin', async (options, callback) => {
  try {
    // 预处理逻辑
    console.log('准备创建项目:', options.projectPath)
    
    // 验证项目名称
    if (!isValidProjectName(options.projectName)) {
      throw new Error('无效的项目名称')
    }
    
    // 检查磁盘空间
    await checkDiskSpace(options.projectPath)
    
    callback()
  } catch (error) {
    callback(error)
  }
})

// 同步钩子
launcher.hooks.configResolved.tap('my-plugin', (config) => {
  // 修改配置
  if (process.env.NODE_ENV === 'development') {
    config.define = {
      ...config.define,
      __DEV__: true
    }
  }
})
```

## 检测器扩展

### 自定义项目检测器

```typescript
interface ProjectDetectorExtension {
  name: string
  priority: number
  
  // 检测方法
  detect(projectPath: string): Promise<DetectionResult>
  
  // 支持的项目类型
  supportedTypes: ProjectType[]
}

const myFrameworkDetector: ProjectDetectorExtension = {
  name: 'my-framework-detector',
  priority: 100,
  supportedTypes: ['my-framework'],
  
  async detect(projectPath: string): Promise<DetectionResult> {
    const packageJson = await readPackageJson(projectPath)
    
    // 检测特定依赖
    if (packageJson.dependencies?.['my-framework']) {
      return {
        type: 'my-framework',
        confidence: 0.9,
        signals: [
          {
            type: 'dependency',
            value: 'my-framework',
            weight: 0.8
          }
        ]
      }
    }
    
    // 检测配置文件
    const configExists = await fileExists(path.join(projectPath, 'my-framework.config.js'))
    if (configExists) {
      return {
        type: 'my-framework',
        confidence: 0.7,
        signals: [
          {
            type: 'config-file',
            value: 'my-framework.config.js',
            weight: 0.6
          }
        ]
      }
    }
    
    return null
  }
}

// 注册检测器
launcher.registerDetector(myFrameworkDetector)
```

## API 扩展

### 扩展 ViteLauncher API

```typescript
// 通过插件扩展 API
const apiExtensionPlugin: LauncherPlugin = {
  name: 'api-extension',
  
  apply(launcher: ViteLauncher) {
    // 添加新方法
    launcher.addMethod('deploy', async (options: DeployOptions) => {
      console.log('部署项目:', options)
      // 部署逻辑
    })
    
    // 添加属性
    launcher.addProperty('deployConfig', {
      target: 'production',
      platform: 'vercel'
    })
    
    // 扩展现有方法
    const originalBuild = launcher.build.bind(launcher)
    launcher.build = async (path?: string, options?: BuildOptions) => {
      const result = await originalBuild(path, options)
      
      // 构建后自动部署
      if (options?.autoDeploy) {
        await launcher.deploy({ path, ...options.deployOptions })
      }
      
      return result
    }
  }
}
```

## 扩展最佳实践

### 1. 插件开发规范

- **命名约定**: 使用 `launcher-plugin-` 前缀
- **版本管理**: 遵循语义化版本控制
- **文档完善**: 提供详细的使用文档和示例
- **测试覆盖**: 编写完整的单元测试和集成测试

### 2. 性能考虑

- **懒加载**: 按需加载插件功能
- **缓存机制**: 缓存计算结果和配置
- **异步处理**: 使用异步操作避免阻塞
- **内存管理**: 及时清理不需要的资源

### 3. 兼容性保证

- **向后兼容**: 保持 API 的向后兼容性
- **版本检查**: 检查依赖版本兼容性
- **优雅降级**: 在不支持的环境中优雅降级
- **错误处理**: 提供详细的错误信息和恢复建议

### 4. 社区生态

- **开源发布**: 将有用的插件开源分享
- **文档贡献**: 完善官方文档和示例
- **问题反馈**: 积极参与问题讨论和解决
- **标准制定**: 参与扩展标准的制定和完善
